<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>监督检查 - 项目管理系统</title>
    <link rel="stylesheet" href="css/project-form.css">
    <style>
        body {
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1000px; /* 减小最大宽度 */
            margin: 0 auto;
            padding: 40px; /* 增加内边距 */
        }
        .section {
            margin-bottom: 30px; /* 增加部分之间的间距 */
            background-color: #fff;
            padding: 30px; /* 增加内部填充 */
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-row {
            display: flex;
            margin-bottom: 20px; /* 增加行间距 */
        }
        .form-field {
            flex: 1;
            margin-right: 20px; /* 增加字段间距 */
        }
        .form-field:last-child {
            margin-right: 0;
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .form-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .radio-group {
            display: flex;
        }
        .radio-group label {
            margin-right: 30px; /* 增加单选按钮间距 */
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        .btn-nav {
            background-color: #1e88e5;
            color: white;
        }
        .btn-nav:hover {
            background-color: #1565c0;
        }
        .btn-function {
            background-color: #4caf50;
            color: white;
        }
        .btn-function:hover {
            background-color: #45a049;
        }
        .form-row-special {
            display: flex;
            margin-bottom: 25px; /* 增加特殊行的间距 */
            align-items: flex-end; /* 将对齐方式改为底部对齐 */
        }
        .form-field-label {
            flex: 0 0 30%;
            margin-right: 20px;
            padding-bottom: 8px; /* 添加底部内边距，使其与输入框底部对齐 */
        }
        .form-field-input {
            flex: 1;
            position: relative;
        }
        .form-input-underline {
            width: 100%;
            border: none;
            border-bottom: 1px solid #ddd;
            padding: 5px 0;
            outline: none;
            background-color: transparent;
        }
        .form-label-float {
            position: absolute;
            left: 0;
            bottom: 5px;
            transition: all 0.2s ease-out;
            pointer-events: none;
        }
        .form-input-underline:focus + .form-label-float,
        .form-input-underline:not(:placeholder-shown) + .form-label-float {
            opacity: 0;
        }
        .image-gallery th {
            background-color: #e0e0e0;
            color: #333;
        }
        .section-buttons {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
        .btn-edit {
            background-color: #ffa000;
            color: white;
        }
        .btn-edit:hover {
            background-color: #ff8f00;
        }
        .btn-save {
            background-color: #4caf50;
            color: white;
        }
        .btn-save:hover {
            background-color: #45a049;
        }
        .image-gallery table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; /* 添加这一行以确保列宽设置生效 */
        }
        .image-gallery th, .image-gallery td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center; /* 将文本对齐方式改为居中 */
            vertical-align: middle; /* 垂直居中 */
            overflow: hidden; /* 添加这一行以处理内容溢出 */
            text-overflow: ellipsis; /* 添加这一行以在内容溢出时显示省略号 */
            white-space: nowrap; /* 添加这一行以防止内容换行 */
        }
        .image-gallery th {
            background-color: #f2f2f2;
        }
        .image-gallery th:nth-child(1), .image-gallery td:nth-child(1) { width: 10%; }
        .image-gallery th:nth-child(2), .image-gallery td:nth-child(2) { width: 30%; }
        .image-gallery th:nth-child(3), .image-gallery td:nth-child(3) { width: 30%; }
        .image-gallery th:nth-child(4), .image-gallery td:nth-child(4) { width: 20%; }
        .image-gallery th:nth-child(5), .image-gallery td:nth-child(5) { width: 10%; font-size: inherit; text-align: center; }
        .image-gallery select {
            font-size: inherit;
            width: 100%;
        }
        .image-actions {
            white-space: nowrap;
        }
        .image-actions button {
            padding: 5px 10px;
            margin-right: 5px;
        }
        .required::after {
            content: "*";
            color: red;
            margin-left: 4px;
        }
        .header-actions {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }

        .header-actions button {
            margin-left: 10px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        .btn-edit {
            background-color: #ffa000;
            color: white;
        }

        .btn-edit:hover {
            background-color: #ff8f00;
        }

        .btn-save {
            background-color: #4caf50;
            color: white;
        }

        .btn-save:hover {
            background-color: #45a049;
        }

        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
            height: 20px;
        }

        .progress-bar {
            height: 100%;
            width: 0;
            transition: width 0.5s ease-in-out;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: black;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>项目管理系统</h1>
        </header>
        <div class="header-actions">
            <button type="button" class="btn btn-edit" onclick="editForm()" style="display:none;">修改</button>
            <button type="button" class="btn btn-save" onclick="saveSupervisionData()">保存</button>
            <button class="btn btn-nav" onclick="location.href='supervision-list.html'">返回上一页</button>
        </div>
        <form id="supervisionForm">
            <div class="section">
                <h2>基本信息</h2>
                <div class="form-row">
                    <div class="form-field">
                        <label class="form-label required">检查日期</label>
                        <input type="date" name="inspectionDate" class="form-input" required>
                    </div>
                    <div class="form-field">
                        <label class="form-label required">检查人员</label>
                        <input type="text" name="inspector" class="form-input" required>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label class="form-label">检查类型</label>
                        <select name="inspectionType" class="form-input">
                            <option value="">请选择</option>
                            <option value="日常检查">日常检查</option>
                            <option value="专项检查">专项检查</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label class="form-label">检查结果</label>
                        <select name="inspectionResult" class="form-input">
                            <option value="">请选择</option>
                            <option value="合格">合格</option>
                            <option value="不合格">不合格</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label class="form-label">检查内容</label>
                        <textarea name="inspectionContent" class="form-input" rows="4"></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label class="form-label">存在问题</label>
                        <textarea name="existingIssues" class="form-input" rows="4"></textarea>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label class="form-label">整改建议</label>
                        <textarea name="rectificationSuggestions" class="form-input" rows="4"></textarea>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2>检查图库</h2>
                <div>
                    <input type="file" id="imageUpload" accept="image/*" style="display: none;" multiple>
                    <button type="button" class="btn btn-function" onclick="triggerImageUpload(event)">上传图片</button>
                    <button type="button" class="btn btn-function" onclick="deleteSelectedImages(event)">删除选中</button>
                </div>
                <div class="image-gallery">
                    <table id="imageList">
                        <tr>
                            <th>选中</th>
                            <th>文件名</th>
                            <th>上传时间</th>
                            <th>操作</th>
                            <th>图片类型</th>
                        </tr>
                    </table>
                </div>
            </div>
        </form>
    </div>

    <script>
        let imageFiles = [];

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('id');
            const isNewDump = !editId;

            localStorage.setItem('isNewDump', isNewDump);

            if (!isNewDump) {
                // 编辑模式
                loadDumpData(editId);
                disableForm();
                document.querySelector('.btn-edit').style.display = 'inline-block';
                document.querySelector('.btn-save').style.display = 'none';
            } else {
                // 新建模式
                document.querySelector('.btn-edit').style.display = 'none';
                document.querySelector('.btn-save').style.display = 'inline-block';
            }

            // 为渣场名称输入框添加事件监听器
            const dumpNameInput = document.querySelector('input[name="dumpName"]');
            dumpNameInput.addEventListener('change', checkDumpNameExists);

            // 为其他输入框添加事件监听器
            const form = document.getElementById('dumpForm');
            form.addEventListener('input', function(event) {
                if (event.target.name !== 'dumpName' && dumpNameInput.value.trim() !== '') {
                    checkDumpNameExists.call(dumpNameInput);
                }
            });

            // 为实际堆渣量和设计堆渣量输入框添加事件监听器
            const actualCapacityInput = document.querySelector('input[name="actualCapacity"]');
            const designedCapacityInput = document.querySelector('input[name="designedCapacity"]');

            actualCapacityInput.addEventListener('input', updateDumpProgress);
            designedCapacityInput.addEventListener('input', updateDumpProgress);

            // 如果是编辑模式，立即更新进度条
            if (!isNewDump) {
                updateDumpProgress();
            }
        });

        function checkDumpNameExists() {
            const dumpName = this.value.trim();
            if (dumpName) {
                const dumps = JSON.parse(localStorage.getItem('dumps')) || [];
                const existingDump = dumps.find(d => d.dumpName === dumpName && d.dumpId !== document.querySelector('input[name="dumpId"]')?.value);
                if (existingDump) {
                    alert('渣场名称已存在，请重新输入');
                    this.value = ''; // 清空输入
                    this.focus(); // 重新聚焦到输入框
                }
            }
        }

        function saveDumpData() {
            // 收集表单数据
            const formData = new FormData(document.getElementById('dumpForm'));
            const dumpData = Object.fromEntries(formData.entries());

            // 检查必填项
            if (!dumpData.dumpName || !dumpData.dumpLocation || !dumpData.dumpStatus) {
                alert('渣场名称、渣场位置和渣场状态为必填项，请填写完整。');
                return;
            }

            // 获取现有的渣场数据
            let dumps = JSON.parse(localStorage.getItem('dumps')) || [];

            const isNewDump = localStorage.getItem('isNewDump') === 'true';
            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('id');

            // 添加图片数据
            dumpData.images = imageFiles.map(file => ({
                name: file.name,
                uploadTime: file.uploadTime,
                dataUrl: file.dataUrl,
                type: file.type
            }));

            if (isNewDump) {
                // 新建渣场
                dumpData.dumpId = Date.now().toString();
                dumps.push(dumpData);
            } else {
                // 更新现有渣场
                const editIndex = dumps.findIndex(dump => dump.dumpId === editId);
                if (editIndex !== -1) {
                    // 保留原有的 dumpId
                    dumpData.dumpId = editId;
                    dumps[editIndex] = dumpData;
                } else {
                    alert('未找到要编辑的渣场数据');
                    return;
                }
            }

            // 保存更新后的数据
            localStorage.setItem('dumps', JSON.stringify(dumps));

            // 清除 isNewDump 标志
            localStorage.removeItem('isNewDump');

            // 禁用表单字段
            disableForm();

            // 显示保存成功消息
            alert('保存成功');

            // 跳转回列表页面
            window.location.href = 'dump-list.html';
        }

        function disableForm() {
            const form = document.getElementById('dumpForm');
            const inputs = form.querySelectorAll('input:not([type="hidden"]), select, textarea');
            inputs.forEach(input => {
                input.disabled = true;
            });
            document.querySelector('.btn-edit').style.display = 'inline-block';
            document.querySelector('.btn-save').style.display = 'none';
        }

        function editForm() {
            const form = document.getElementById('dumpForm');
            const inputs = form.querySelectorAll('input:not([type="hidden"]), select, textarea');
            inputs.forEach(input => {
                input.disabled = false;
            });
            document.querySelector('.btn-edit').style.display = 'none';
            document.querySelector('.btn-save').style.display = 'inline-block';
        }

        function loadDumpData(dumpId) {
            const dumps = JSON.parse(localStorage.getItem('dumps')) || [];
            const dumpData = dumps.find(dump => dump.dumpId === dumpId);

            if (dumpData) {
                Object.keys(dumpData).forEach(key => {
                    const element = document.querySelector(`[name="${key}"]`);
                    if (element) {
                        if (element.type === 'radio') {
                            const radio = document.querySelector(`[name="${key}"][value="${dumpData[key]}"]`);
                            if (radio) {
                                radio.checked = true;
                            }
                        } else {
                            element.value = dumpData[key];
                        }
                    }
                });
                // 设置隐藏的 dumpId 字段
                const dumpIdField = document.createElement('input');
                dumpIdField.type = 'hidden';
                dumpIdField.name = 'dumpId';
                dumpIdField.value = dumpId;
                document.getElementById('dumpForm').appendChild(dumpIdField);

                // 加载图片数据
                if (dumpData.images && dumpData.images.length > 0) {
                    dumpData.images.forEach(image => {
                        const row = document.createElement('tr');
                        row.setAttribute('data-url', image.dataUrl);
                        row.innerHTML = `
                            <td><input type="checkbox"></td>
                            <td>${image.name}</td>
                            <td>${image.uploadTime}</td>
                            <td class="image-actions">
                                <button onclick="previewImage('${image.dataUrl}', event)">预览</button>
                                <button onclick="downloadImage('${image.name}', '${image.dataUrl}', event)">下载</button>
                            </td>
                            <td>
                                <span onclick="showImageTypeSelect(this)">${image.type}</span>
                            </td>
                        `;
                        document.getElementById('imageList').appendChild(row);
                    });
                    updateImageFiles();
                }

                // 更新堆渣进度
                updateDumpProgress();
            }
        }

        // 添加以下 JavaScript 代码来自动调整 textarea 的高度
        document.querySelectorAll('.form-input-underline').forEach(function(textarea) {
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                // 确保最小高度
                if (this.scrollHeight < 30) {
                    this.style.height = '30px';
                }
                // 当有内容时隐藏标签
                if (this.value.trim() !== '') {
                    this.nextElementSibling.style.opacity = '0';
                } else {
                    this.nextElementSibling.style.opacity = '1';
                }
            });
            // 初始化时触发一次以设置正确的高度和标签可见性
            textarea.dispatchEvent(new Event('input'));
        });

        function triggerImageUpload(event) {
            event.preventDefault();
            document.getElementById('imageUpload').click();
        }

        function deleteSelectedImages(event) {
            event.preventDefault();
            const checkboxes = document.querySelectorAll('#imageList input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                if (checkbox.id !== 'selectAll') {
                    const row = checkbox.closest('tr');
                    row.remove();
                }
            });
            updateImageFiles();
        }

        function toggleSelectAll(event) {
            const checkboxes = document.querySelectorAll('#imageList input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.id !== 'selectAll') {
                    checkbox.checked = event.target.checked;
                }
            });
        }

        function updateImageFiles() {
            imageFiles = Array.from(document.querySelectorAll('#imageList tr')).slice(1).map(row => {
                return {
                    name: row.cells[1].textContent,
                    uploadTime: row.cells[2].textContent,
                    dataUrl: row.getAttribute('data-url'),
                    type: row.cells[4].querySelector('span')?.textContent || row.cells[4].querySelector('select')?.value
                };
            });
        }

        document.getElementById('imageUpload').addEventListener('change', function(event) {
            const files = event.target.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const row = document.createElement('tr');
                    row.setAttribute('data-url', e.target.result);
                    row.innerHTML = `
                        <td><input type="checkbox"></td>
                        <td>${file.name}</td>
                        <td>${new Date().toLocaleString()}</td>
                        <td class="image-actions">
                            <button onclick="previewImage('${e.target.result}', event)">预览</button>
                            <button onclick="downloadImage('${file.name}', '${e.target.result}', event)">下载</button>
                        </td>
                        <td>
                            <select onchange="updateImageType(this)">
                                <option value="">请选择</option>
                                <option value="航拍全景">航拍全景</option>
                                <option value="渣场局部">渣场局部</option>
                                <option value="其他">其他</option>
                            </select>
                        </td>
                    `;
                    const table = document.getElementById('imageList');
                    const firstDataRow = table.rows[1]; // 获取标题行之后的第一行
                    if (firstDataRow) {
                        table.insertBefore(row, firstDataRow); // 在第一行数据之前插入新行
                    } else {
                        table.appendChild(row); // 如果没有数据行，则直接添加到表格末尾
                    }
                    updateImageFiles();
                };
                reader.readAsDataURL(file);
            }
        });

        function updateImageType(select) {
            const row = select.closest('tr');
            const imageFile = imageFiles.find(file => file.name === row.cells[1].textContent);
            if (imageFile) {
                imageFile.type = select.value;
                // 更新显示，隐藏下拉菜单，只显示选中的文字
                const selectedText = select.options[select.selectedIndex].text;
                select.style.display = 'none';
                const textSpan = document.createElement('span');
                textSpan.textContent = selectedText;
                textSpan.style.cursor = 'pointer';
                textSpan.onclick = function() {
                    textSpan.style.display = 'none';
                    select.style.display = '';
                };
                select.parentNode.insertBefore(textSpan, select);
            }
        }

        function showImageTypeSelect(span) {
            span.style.display = 'none';
            const td = span.closest('td');
            const select = td.querySelector('select');
            if (select) {
                select.style.display = '';
            } else {
                const newSelect = document.createElement('select');
                newSelect.innerHTML = `
                    <option value="">请选择</option>
                    <option value="航拍全景">航拍全景</option>
                    <option value="渣场局部">渣场局部</option>
                    <option value="其他">其他</option>
                `;
                newSelect.value = span.textContent;
                newSelect.onchange = function() {
                    updateImageType(this);
                };
                td.appendChild(newSelect);
            }
        }

        function previewImage(src, event) {
            event.preventDefault();
            event.stopPropagation();
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '1000';

            const imgContainer = document.createElement('div');
            imgContainer.style.position = 'relative';
            imgContainer.style.maxWidth = '90%';
            imgContainer.style.maxHeight = '90%';

            const img = document.createElement('img');
            img.src = src;
            img.style.maxWidth = '100%';
            img.style.maxHeight = '100%';
            img.style.display = 'block';
            img.style.borderRadius = '5px';

            const closeButton = document.createElement('button');
            closeButton.textContent = '关闭';
            closeButton.style.position = 'absolute';
            closeButton.style.top = '10px';
            closeButton.style.right = '10px';
            closeButton.style.padding = '5px 10px';
            closeButton.style.fontSize = '16px';
            closeButton.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
            closeButton.style.border = 'none';
            closeButton.style.borderRadius = '5px';
            closeButton.style.cursor = 'pointer';

            closeButton.addEventListener('click', function(e) {
                e.stopPropagation();
                document.body.removeChild(modal);
            });

            imgContainer.appendChild(img);
            imgContainer.appendChild(closeButton);
            modal.appendChild(imgContainer);
            document.body.appendChild(modal);

            modal.addEventListener('click', function() {
                document.body.removeChild(modal);
            });

            imgContainer.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }

        function downloadImage(fileName, dataUrl, event) {
            event.preventDefault();
            event.stopPropagation();
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function updateDumpProgress() {
            const actualCapacity = parseFloat(document.querySelector('input[name="actualCapacity"]').value) || 0;
            const designedCapacity = parseFloat(document.querySelector('input[name="designedCapacity"]').value) || 1;
            
            const progress = actualCapacity / designedCapacity;
            const progressPercentage = Math.min(progress * 100, 100).toFixed(2);
            
            const progressBar = document.getElementById('dumpProgress');
            const progressText = document.getElementById('dumpProgressText');
            
            progressBar.style.width = `${progressPercentage}%`;
            progressBar.style.backgroundColor = progress > 1 ? 'red' : 'green';
            progressText.textContent = `${progressPercentage}%`;
        }
    </script>
</body>
</html>