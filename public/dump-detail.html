<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>渣场详情 - 项目管理系统</title>
    <link rel="stylesheet" href="css/project-form.css">
    <style>
        body {
            background-color: #f4f4f4;
        }
        .container {
            max-width: 1000px; /* 减小最大宽度 */
            margin: 0 auto;
            padding: 40px; /* 增加内边距 */
        }
        .section {
            margin-bottom: 30px; /* 增加部分之间的间距 */
            background-color: #fff;
            padding: 30px; /* 增加内部填充 */
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .form-row {
            display: flex;
            margin-bottom: 20px; /* 增加行间距 */
        }
        .form-field {
            flex: 1;
            margin-right: 20px; /* 增加字段间距 */
        }
        .form-field:last-child {
            margin-right: 0;
        }
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        .form-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .radio-group {
            display: flex;
        }
        .radio-group label {
            margin-right: 30px; /* 增加单选按钮间距 */
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        .btn-nav {
            background-color: #1e88e5;
            color: white;
        }
        .btn-nav:hover {
            background-color: #1565c0;
        }
        .btn-function {
            background-color: #4caf50;
            color: white;
        }
        .btn-function:hover {
            background-color: #45a049;
        }
        .form-row-special {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 15px;
        }
        .form-field-label {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            margin-bottom: 10px;
            width: 100%;
        }
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 5px;
        }
        .radio-group label {
            display: flex;
            align-items: center;
        }
        .radio-group input[type="radio"] {
            margin-right: 5px;
        }
        .form-field-input {
            flex: 1;
            position: relative;
        }
        .form-input-underline {
            width: 100%;
            border: none;
            border-bottom: 1px solid #ddd;
            padding: 5px 0;
            outline: none;
            background-color: transparent;
        }
        .form-label-float {
            position: absolute;
            left: 0;
            bottom: 5px;
            transition: all 0.2s ease-out;
            pointer-events: none;
        }
        .form-input-underline:focus + .form-label-float,
        .form-input-underline:not(:placeholder-shown) + .form-label-float {
            opacity: 0;
        }
        .image-gallery th {
            background-color: #e0e0e0;
            color: #333;
        }
        .section-buttons {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
        .btn-edit {
            background-color: #ffa000;
            color: white;
        }
        .btn-edit:hover {
            background-color: #ff8f00;
        }
        .btn-save {
            background-color: #4caf50;
            color: white;
        }
        .btn-save:hover {
            background-color: #45a049;
        }
        .image-gallery table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; /* 添加这一行以确保列宽设置生效 */
        }
        .image-gallery th, .image-gallery td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center; /* 将文本对齐方式改为居中 */
            vertical-align: middle; /* 垂直居中 */
            overflow: hidden; /* 添加这一行以处理内容溢出 */
            text-overflow: ellipsis; /* 添加这一行以在内容溢出时显示省略号 */
            white-space: nowrap; /* 添加这一行以防止内容换行 */
        }
        .image-gallery th {
            background-color: #f2f2f2;
        }
        .image-gallery th:nth-child(1), .image-gallery td:nth-child(1) { width: 10%; }
        .image-gallery th:nth-child(2), .image-gallery td:nth-child(2) { width: 30%; }
        .image-gallery th:nth-child(3), .image-gallery td:nth-child(3) { width: 30%; }
        .image-gallery th:nth-child(4), .image-gallery td:nth-child(4) { width: 20%; }
        .image-gallery th:nth-child(5), .image-gallery td:nth-child(5) { width: 10%; font-size: inherit; text-align: center; }
        .image-gallery select {
            font-size: inherit;
            width: 100%;
        }
        .image-actions {
            white-space: nowrap;
        }
        .image-actions button {
            padding: 5px 10px;
            margin-right: 5px;
        }
        .required::after {
            content: "*";
            color: red;
            margin-left: 4px;
        }
        .header-actions {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }

        .header-actions button {
            margin-left: 10px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s ease;
        }

        .btn-edit {
            background-color: #ffa000;
            color: white;
        }

        .btn-edit:hover {
            background-color: #ff8f00;
        }

        .btn-save {
            background-color: #4caf50;
            color: white;
        }

        .btn-save:hover {
            background-color: #45a049;
        }

        .progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
            height: 20px;
        }

        .progress-bar {
            height: 100%;
            width: 0;
            transition: width 0.5s ease-in-out;
        }

        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: black;
            font-weight: bold;
        }

        .design-plan-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-input-container {
            flex: 1;
            margin-right: 10px;
            position: relative;
        }

        .file-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .file-input-label {
            position: absolute;
            top: 0;
            right: 0;
            padding: 8px 12px;
            background-color: #f0f0f0;
            color: #333;
            cursor: pointer;
            border-radius: 0 4px 4px 0;
        }

        .button-group {
            display: flex;
            gap: 5px;
        }

        .btn {
            padding: 8px 12px;
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn:hover {
            background-color: #e0e0e0;
        }

        .file-upload-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .file-input-container {
            display: flex;
            align-items: center;
        }

        .file-input {
            flex: 1;
            margin-right: 10px;
        }

        .button-group {
            display: flex;
            gap: 5px;
            justify-content: flex-start;
        }

        .form-row-special {
            display: flex;
            flex-direction: column;
            margin-bottom: 15px;
        }

        .form-field-label {
            margin-bottom: 10px;
        }

        .form-field-input {
            width: 100%;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>渣场详情</h1>
        </header>
        <div class="header-actions">
            <button type="button" class="btn btn-edit" onclick="editForm()">修改</button>
            <button type="button" class="btn btn-save" onclick="saveDumpData()">保存</button>
            <button class="btn btn-nav" onclick="location.href='dump-list.html'">返回列表</button>
        </div>
        <form id="dumpForm">
            <div class="section">
                <h2>基本信息</h2>
                <div class="form-row">
                    <div class="form-field">
                        <label class="form-label required">渣场名称</label>
                        <input type="text" name="dumpName" class="form-input" required>
                    </div>
                    <div class="form-field">
                        <label class="form-label required">渣场状态</label>
                        <select name="dumpStatus" class="form-input" required>
                            <option value="">请选择</option>
                            <option value="未启用">未启用</option>
                            <option value="使用中">使用中</option>
                            <option value="堆渣完毕">堆渣完毕</option>
                            <option value="已移交">已移交</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label class="form-label required">渣场位置</label>
                        <input type="text" name="dumpLocation" class="form-input" required>
                    </div>
                    <div class="form-field">
                        <label class="form-label">经纬度</label>
                        <input type="text" name="coordinates" class="form-input">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label class="form-label required">渣场类型</label>
                        <select name="dumpType" class="form-input" onchange="toggleResidentsNearbySection()" required>
                            <option value="">请选择</option>
                            <option value="沟道型">沟道型</option>
                            <option value="临河型">临河型</option>
                            <option value="坡地型">坡地型</option>
                            <option value="库区型">库区型</option>
                        </select>
                    </div>
                    <div class="form-field">
                        <label class="form-label required">渣场等级</label>
                        <select name="dumpLevel" class="form-input" style="display:inline-block; width:calc(100% - 100px);" required>
                            <option value="">请选择</option>
                            <option value="1级">1级</option>
                            <option value="2级">2级</option>
                            <option value="3级">3级</option>
                            <option value="4级">4级</option>
                        </select>
                        <a href="javascript:void(0);" onclick="openImage()" style="display:inline-block; float:right; margin-left:10px;">判定依据</a>
                    </div>
                    <div id="imageModal" style="display:none; position:fixed; top:0; left:50%; transform:translateX(-50%); width:80%; height:80%; background-color:rgba(0,0,0,0.5); overflow-y:auto;">
                        <div style="position:relative; width:80%; height:auto; margin:auto; top:2%; text-align:center;">
                            <img src="images\渣场等级划分标准.jpg" style="width:100%; height:auto; max-width:80%;">
                            <span style="position:absolute; top:10px; right:10%; cursor:pointer; color:red;" onclick="closeImage()">关闭</span>
                        </div>
                </div>
                    <script>
                        function openImage() {
                            document.getElementById('imageModal').style.display = 'block';
                        }
                        function closeImage() {
                            document.getElementById('imageModal').style.display = 'none';
                        }
                    </script>
                    </div>
                <div class="form-row">
                    <div class="form-field">
                        <label class="form-label">批复占地面积（hm²）</label>
                        <input type="text" name="approvedArea" class="form-input">
                    </div>
                    <div class="form-field">
                        <label class="form-label">实际占地面积（hm²）</label>
                        <input type="text" name="actualArea" class="form-input">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label class="form-label">批复堆高（m）</label>
                        <input type="text" name="approvedHeight" class="form-input">
                    </div>
                    <div class="form-field">
                        <label class="form-label">实际堆高（m）</label>
                        <input type="text" name="actualHeight" class="form-input">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label class="form-label">批复堆渣量（万m³）</label>
                        <input type="text" name="approvedCapacity" class="form-input" oninput="updateProgress()">
                    </div>
                    <div class="form-field">
                        <label class="form-label">实际堆渣量（万m³）</label>
                        <input type="text" name="actualCapacity" class="form-input" oninput="updateProgress()">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-field">
                        <label class="form-label">堆渣进度</label>
                        <div class="progress-container">
                            <div id="dumpProgress" class="progress-bar"></div>
                            <div id="dumpProgressText" class="progress-text"></div>
                        </div>
                    </div>
                </div>
                <script>
                    function updateProgress() {
                        var approvedCapacity = parseFloat(document.getElementsByName('approvedCapacity')[0].value) || 0;
                        var actualCapacity = parseFloat(document.getElementsByName('actualCapacity')[0].value) || 0;
                        
                        if (approvedCapacity > 0) {
                            var progress = (actualCapacity / approvedCapacity);
                            var progressPercentage = Math.min(progress * 100, 100).toFixed(2);
                            document.getElementById('dumpProgress').style.width = progressPercentage + '%';
                            document.getElementById('dumpProgressText').innerText = progressPercentage + '%';
                            
                            // 根据进度值设置颜色
                            if (progress >= 1) {
                                document.getElementById('dumpProgress').style.backgroundColor = 'red';
                            } else {
                                document.getElementById('dumpProgress').style.backgroundColor = 'green';
                            }
                        } else {
                            document.getElementById('dumpProgress').style.width = '0%';
                            document.getElementById('dumpProgressText').innerText = '0%';
                            document.getElementById('dumpProgress').style.backgroundColor = 'green';
                        }
                    }

                    // 页面加载时初始化进度条
                    document.addEventListener('DOMContentLoaded', function() {
                        updateProgress();
                    });
                </script>
            </div>
            <div class="section">
                <h2>渣场隐患排查</h2>
            <div class="form-row-special">
                <div class="form-field-label">
                    <label class="form-label">是否是水保方案批复渣场</label>
                    <div class="radio-group">
                        <label><input type="radio" name="hasLandProcedures" value="是" onclick="toggleChangeManagement(false)"> 是</label>
                        <label><input type="radio" name="hasLandProcedures" value="否" onclick="toggleChangeManagement(true)"> 否</label>
                    </div>
                </div>
                <div class="form-field-input">
                    <textarea name="landProceduresNote" class="form-input-underline" placeholder=" " rows="1"></textarea>
                    <label for="landProceduresNote" class="form-label-float">情况说明</label>
                </div>
            </div>
            <div class="form-row-special" id="changeManagement" style="display: none;">    
                <div class="form-field-label">
                    <label class="form-label">是否纳入方案变更管理</label>
                    <div class="radio-group">
                        <label><input type="radio" name="includedInChangeManagement" value="是" onclick="toggleFollowUpPlan(false)"> 是</label>
                        <label><input type="radio" name="includedInChangeManagement" value="否" onclick="toggleFollowUpPlan(true)"> 否</label>
                        <label style="display:none;"><input type="radio" name="includedInChangeManagement" value="" checked></label>
                    </div>
                </div>
                <div class="form-field-input">
                    <textarea name="changeManagementNote" class="form-input-underline" placeholder=" " rows="1"></textarea>
                    <label for="changeManagementNote" class="form-label-float">情况说明</label>
                </div>
            </div>
            <div class="form-row-special" id="followUpPlan" style="display: none;">
                <div class="form-field-label">
                    <label class="form-label">是否有后续清运计划</label>
                    <div class="radio-group">
                        <label><input type="radio" name="hasFollowUpPlan" value="是"> 是</label>
                        <label><input type="radio" name="hasFollowUpPlan" value="否"> 否</label>
                    </div>
                </div>
                <div class="form-field-input">
                    <textarea name="followUpPlanNote" class="form-input-underline" placeholder=" " rows="1"></textarea>
                    <label for="followUpPlanNote" class="form-label-float">情况说明</label>
                </div>
            </div>
            <script>
                function toggleChangeManagement(show) {
                    document.getElementById('changeManagement').style.display = show ? 'block' : 'none';
                    if (!show) {
                        toggleFollowUpPlan(false);
                    }
                }

                function toggleFollowUpPlan(show) {
                    document.getElementById('followUpPlan').style.display = show ? 'block' : 'none';
                }
            </script>
            <!-- 是否有渣场设计方案 -->
            <div class="form-row-special">
                <div class="form-field-label">
                    <label class="form-label">是否有渣场设计方案</label>
                    <div class="radio-group">
                        <label><input type="radio" name="hasDesignPlan" value="是" onclick="toggleFileUpload('designPlan', true)"> 是</label>
                        <label><input type="radio" name="hasDesignPlan" value="否" onclick="toggleFileUpload('designPlan', false)"> 否</label>
                    </div>
                </div>
                <div class="form-field-input file-upload-container" id="designPlanUpload" style="display: none;">
                    <div class="file-input-container">
                        <input type="text" id="designPlanFileName" readonly class="file-input" placeholder="未选择文件">
                        <label for="designPlanFile" class="file-input-label">选择文件</label>
                        <input type="file" id="designPlanFile" style="display: none;" accept=".pdf,.doc,.docx">
                    </div>
                    <div class="button-group">
                        <button type="button" class="btn" onclick="document.getElementById('designPlanFile').click()">上传</button>
                        <button type="button" class="btn" onclick="previewFile('designPlan')">预览</button>
                        <button type="button" class="btn" onclick="downloadFile('designPlan')">下载</button>
                        <button type="button" class="btn" onclick="deleteFile('designPlan')">取消</button>
                    </div>
                </div>
            </div>
            <div class="form-row-special" id="designPlanNote" style="display: none;">
                <div class="form-field-input">
                    <textarea name="designPlanNote" class="form-input-underline" placeholder=" " rows="1"></textarea>
                    <label for="designPlanNote" class="form-label-float">情况说明</label>
                </div>
            </div>

            <!-- 是否已编制稳评报告 -->
            <div class="form-row-special">
                <div class="form-field-label">
                    <label class="form-label">是否已编制稳评报告</label>
                    <div class="radio-group">
                        <label><input type="radio" name="hasStabilityReport" value="是" onclick="toggleFileUpload('stabilityReport', true)"> 是</label>
                        <label><input type="radio" name="hasStabilityReport" value="否" onclick="toggleFileUpload('stabilityReport', false)"> 否</label>
                    </div>
                </div>
                <div class="form-field-input file-upload-container" id="stabilityReportUpload" style="display: none;">
                    <div class="file-input-container">
                        <input type="text" id="stabilityReportFileName" readonly class="file-input" placeholder="未选择文件">
                        <label for="stabilityReportFile" class="file-input-label">选择文件</label>
                        <input type="file" id="stabilityReportFile" style="display: none;" accept=".pdf,.doc,.docx">
                    </div>
                    <div class="button-group">
                        <button type="button" class="btn" onclick="document.getElementById('stabilityReportFile').click()">上传</button>
                        <button type="button" class="btn" onclick="previewFile('stabilityReport')">预览</button>
                        <button type="button" class="btn" onclick="downloadFile('stabilityReport')">下载</button>
                        <button type="button" class="btn" onclick="deleteFile('stabilityReport')">取消</button>
                    </div>
                </div>
            </div>
            <div class="form-row-special" id="stabilityReportNote" style="display: none;">
                <div class="form-field-input">
                    <textarea name="stabilityReportNote" class="form-input-underline" placeholder=" " rows="1"></textarea>
                    <label for="stabilityReportNote" class="form-label-float">情况说明</label>
                </div>
            </div>

            <!-- 是否已编制地质灾害报告 -->
            <div class="form-row-special">
                <div class="form-field-label">
                    <label class="form-label">是否已编制地质灾害报告</label>
                    <div class="radio-group">
                        <label><input type="radio" name="hasGeologicalHazardReport" value="是" onclick="toggleFileUpload('geologicalHazardReport', true)"> 是</label>
                        <label><input type="radio" name="hasGeologicalHazardReport" value="否" onclick="toggleFileUpload('geologicalHazardReport', false)"> 否</label>
                    </div>
                </div>
                <div class="form-field-input file-upload-container" id="geologicalHazardReportUpload" style="display: none;">
                    <div class="file-input-container">
                        <input type="text" id="geologicalHazardReportFileName" readonly class="file-input" placeholder="未选择文件">
                        <label for="geologicalHazardReportFile" class="file-input-label">选择文件</label>
                        <input type="file" id="geologicalHazardReportFile" style="display: none;" accept=".pdf,.doc,.docx">
                    </div>
                    <div class="button-group">
                        <button type="button" class="btn" onclick="document.getElementById('geologicalHazardReportFile').click()">上传</button>
                        <button type="button" class="btn" onclick="previewFile('geologicalHazardReport')">预览</button>
                        <button type="button" class="btn" onclick="downloadFile('geologicalHazardReport')">下载</button>
                        <button type="button" class="btn" onclick="deleteFile('geologicalHazardReport')">取消</button>
                    </div>
                </div>
            </div>
            <div class="form-row-special" id="geologicalHazardReportNote" style="display: none;">
                <div class="form-field-input">
                    <textarea name="geologicalHazardReportNote" class="form-input-underline" placeholder=" " rows="1"></textarea>
                    <label for="geologicalHazardReportNote" class="form-label-float">情况说明</label>
                </div>
            </div>

            <script>
                function toggleFileUpload(fileType, show) {
                    document.getElementById(`${fileType}Upload`).style.display = show ? 'flex' : 'none';
                    document.getElementById(`${fileType}Note`).style.display = show ? 'block' : 'none';
                }

                function previewFile(fileType) {
                    const fileInput = document.getElementById(`${fileType}File`);
                    const file = fileInput.files[0];
                    if (!file) {
                        alert('请先上传文件');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const content = e.target.result;
                        const modal = document.createElement('div');
                        modal.style.position = 'fixed';
                        modal.style.top = '0';
                        modal.style.left = '0';
                        modal.style.width = '100%';
                        modal.style.height = '100%';
                        modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
                        modal.style.display = 'flex';
                        modal.style.justifyContent = 'center';
                        modal.style.alignItems = 'center';
                        modal.style.zIndex = '1000';

                        const previewContainer = document.createElement('div');
                        previewContainer.style.backgroundColor = 'white';
                        previewContainer.style.padding = '20px';
                        previewContainer.style.borderRadius = '5px';
                        previewContainer.style.maxWidth = '80%';
                        previewContainer.style.maxHeight = '80%';
                        previewContainer.style.overflow = 'auto';

                        if (file.type === 'application/pdf') {
                            const embed = document.createElement('embed');
                            embed.src = URL.createObjectURL(file);
                            embed.type = 'application/pdf';
                            embed.style.width = '100%';
                            embed.style.height = '600px';
                            previewContainer.appendChild(embed);
                        } else {
                            const pre = document.createElement('pre');
                            pre.textContent = content;
                            previewContainer.appendChild(pre);
                        }

                        const closeButton = document.createElement('button');
                        closeButton.textContent = '关闭';
                        closeButton.style.marginTop = '10px';
                        closeButton.onclick = function() {
                            document.body.removeChild(modal);
                        };

                        previewContainer.appendChild(closeButton);
                        modal.appendChild(previewContainer);
                        document.body.appendChild(modal);
                    };

                    if (file.type === 'application/pdf') {
                        reader.readAsDataURL(file);
                    } else {
                        reader.readAsText(file);
                    }
                }

                function downloadFile(fileType) {
                    const fileName = document.getElementById(`${fileType}FileName`).value;
                    const fileInput = document.getElementById(`${fileType}File`);
                    
                    if (fileName && fileInput.files.length > 0) {
                        const file = fileInput.files[0];
                        const url = URL.createObjectURL(file);
                        
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = fileName;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        
                        URL.revokeObjectURL(url);
                    } else {
                        alert('没有可下载的文件');
                    }
                }

                function deleteFile(fileType) {
                    document.getElementById(`${fileType}FileName`).value = '';
                    document.getElementById(`${fileType}File`).value = '';
                    alert('文件已删除');
                }

                document.getElementById('designPlanFile').addEventListener('change', function(event) {
                    updateFileName('designPlan', event);
                });

                document.getElementById('stabilityReportFile').addEventListener('change', function(event) {
                    updateFileName('stabilityReport', event);
                });

                document.getElementById('geologicalHazardReportFile').addEventListener('change', function(event) {
                    updateFileName('geologicalHazardReport', event);
                });

                function updateFileName(fileType, event) {
                    const file = event.target.files[0];
                    if (file) {
                        document.getElementById(`${fileType}FileName`).value = file.name;
                    }
                }
            </script>

            <div class="form-row-special" id="residentsNearbySection" style="display: none;">
                <div class="form-field-label">
                    <label class="form-label">是否在下游1km范围内有居民</label>
                    <div class="radio-group">
                        <label><input type="radio" name="hasResidentsNearby" value="是"> 是</label>
                        <label><input type="radio" name="hasResidentsNearby" value="否"> 否</label>
                    </div>
                </div>
                <div class="form-field-input">
                    <textarea name="residentsNearbyNote" class="form-input-underline" placeholder=" " rows="1"></textarea>
                    <label for="residentsNearbyNote" class="form-label-float">情况说明</label>
                </div>
            </div>
            <script>
                function toggleResidentsNearbySection() {
                    var dumpType = document.getElementsByName('dumpType')[0].value;
                    var residentsNearbySection = document.getElementById('residentsNearbySection');
                    if (dumpType === '沟道型') {
                        residentsNearbySection.style.display = 'flex';
                    } else {
                        residentsNearbySection.style.display = 'none';
                    }
                }
            </script>
            <div class="form-row-special">
                <div class="form-field-label">
                    <label class="form-label">是否侵占河湖水域岸线</label>
                    <div class="radio-group">
                        <label><input type="radio" name="occupiesWaterfront" value="是"> 是</label>
                        <label><input type="radio" name="occupiesWaterfront" value="否"> 否</label>
                    </div>
                </div>
                <div class="form-field-input">
                    <textarea name="occupiesWaterfrontNote" class="form-input-underline" placeholder=" " rows="1"></textarea>
                    <label for="occupiesWaterfrontNote" class="form-label-float">情况说明</label>
                </div>
            </div>
        </div>    
            <div class="section">
                <h2>检查图库</h2>
                <div>
                    <input type="file" id="imageUpload" accept="image/*" style="display: none;" multiple>
                    <button type="button" class="btn btn-function" onclick="triggerImageUpload(event)">上传图片</button>
                    <button type="button" class="btn btn-function" onclick="deleteSelectedImages(event)">删除选中</button>
                </div>
                <div class="image-gallery">
                    <table id="imageList">
                        <tr>
                            <th>选中</th>
                            <th>文件名</th>
                            <th>上传时间</th>
                            <th>操作</th>
                            <th>图片类型</th>
                        </tr>
                    </table>
                </div>
            </div>
        </form>
    </div>

    <script>
        let imageFiles = [];

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const dumpId = urlParams.get('id');
            if (dumpId) {
                loadDumpData(dumpId);
                disableForm();
                document.querySelector('.btn-edit').style.display = 'inline-block';
                document.querySelector('.btn-save').style.display = 'none';
            } else {
                document.querySelector('.btn-edit').style.display = 'none';
                document.querySelector('.btn-save').style.display = 'inline-block';
            }

            // 为渣场名称输入框添加事件监听器
            const dumpNameInput = document.querySelector('input[name="dumpName"]');
            dumpNameInput.addEventListener('change', checkDumpNameExists);

            // 为其他输入框添加事件监听器
            const form = document.getElementById('dumpForm');
            form.addEventListener('input', function(event) {
                if (event.target.name !== 'dumpName' && dumpNameInput.value.trim() !== '') {
                    checkDumpNameExists.call(dumpNameInput);
                }
            });

            // 为实际堆渣量和设计堆渣量输入框添加事件监听器
            const actualCapacityInput = document.querySelector('input[name="actualCapacity"]');
            const designedCapacityInput = document.querySelector('input[name="designedCapacity"]');

            actualCapacityInput.addEventListener('input', updateDumpProgress);
            designedCapacityInput.addEventListener('input', updateDumpProgress);

            // 如果是编辑模式，立即更新进度条
            if (dumpId) {
                updateDumpProgress();
            }
        });

        function checkDumpNameExists() {
            const dumpName = this.value.trim();
            if (dumpName) {
                const dumps = JSON.parse(localStorage.getItem('dumps')) || [];
                const existingDump = dumps.find(d => d.dumpName === dumpName && d.dumpId !== document.querySelector('input[name="dumpId"]')?.value);
                if (existingDump) {
                    alert('渣场名称已存在，请重新输入');
                    this.value = ''; // 清空输入
                    this.focus(); // 重新聚焦到输入框
                }
            }
        }

        function saveDumpData() {
            // 收集表单数据
            const formData = new FormData(document.getElementById('dumpForm'));
            const dumpData = Object.fromEntries(formData.entries());

            // 检查必填项
            const requiredFields = ['dumpName', 'dumpLocation', 'dumpStatus', 'dumpType', 'dumpLevel'];
            const missingFields = requiredFields.filter(field => !dumpData[field]);
            if (missingFields.length > 0) {
                alert(`以下字段为必填项，请填写完整：${missingFields.join(', ')}`);
                return;
            }

            // 获取现有的渣场数据
            let dumps = JSON.parse(localStorage.getItem('dumps')) || [];

            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('id');

            // 添加图片数据
            dumpData.images = imageFiles.map(file => ({
                name: file.name,
                uploadTime: file.uploadTime,
                dataUrl: file.dataUrl,
                type: file.type
            }));

            // 确保所有字段都被包含在dumpData中
            dumpData.coordinates = dumpData.coordinates || '';
            dumpData.approvedHeight = dumpData.approvedHeight || '';
            dumpData.actualHeight = dumpData.actualHeight || '';
            dumpData.approvedCapacity = dumpData.approvedCapacity || '';
            dumpData.actualCapacity = dumpData.actualCapacity || '';

            // 保存堆渣进度
            const approvedCapacity = parseFloat(dumpData.approvedCapacity) || 0;
            const actualCapacity = parseFloat(dumpData.actualCapacity) || 0;
            dumpData.dumpProgress = approvedCapacity > 0 ? (actualCapacity / approvedCapacity * 100).toFixed(2) : '0';

            // 保存其他字段
            dumpData.hasLandProcedures = document.querySelector('input[name="hasLandProcedures"]:checked')?.value || '';
            dumpData.includedInChangeManagement = document.querySelector('input[name="includedInChangeManagement"]:checked')?.value || '';
            dumpData.hasFollowUpPlan = document.querySelector('input[name="hasFollowUpPlan"]:checked')?.value || '';

            // 保存显示状态
            dumpData.showChangeManagement = document.getElementById('changeManagement').style.display !== 'none';
            dumpData.showFollowUpPlan = document.getElementById('followUpPlan').style.display !== 'none';
            dumpData.showResidentsNearby = document.getElementById('residentsNearbySection').style.display !== 'none';
            dumpData.designPlanFileName = document.getElementById('designPlanFileName').value;

            if (editId) {
                // 更新现有渣场
                const editIndex = dumps.findIndex(dump => dump.dumpId === editId);
                if (editIndex !== -1) {
                    dumpData.dumpId = editId;
                    dumps[editIndex] = dumpData;
                } else {
                    alert('未找到要编辑的渣场数据');
                    return;
                }
            } else {
                // 新建渣场
                dumpData.dumpId = Date.now().toString();
                dumps.push(dumpData);
            }

            // 保存更新后的数据
            localStorage.setItem('dumps', JSON.stringify(dumps));

            // 禁用表单字段
            disableForm();

            // 显示保存成功消息
            alert('保存成功');

            // 跳转回列表页面
            window.location.href = 'dump-list.html';
        }

        function disableForm() {
            const form = document.getElementById('dumpForm');
            const inputs = form.querySelectorAll('input:not([type="hidden"]), select, textarea');
            inputs.forEach(input => {
                input.disabled = true;
            });
            document.querySelector('.btn-edit').style.display = 'inline-block';
            document.querySelector('.btn-save').style.display = 'none';
        }

        function editForm() {
            const form = document.getElementById('dumpForm');
            const inputs = form.querySelectorAll('input:not([type="hidden"]), select, textarea');
            inputs.forEach(input => {
                input.disabled = false;
            });
            document.querySelector('.btn-edit').style.display = 'none';
            document.querySelector('.btn-save').style.display = 'inline-block';
        }

        function loadDumpData(dumpId) {
            const dumps = JSON.parse(localStorage.getItem('dumps')) || [];
            const dumpData = dumps.find(dump => dump.dumpId === dumpId);

            if (dumpData) {
                Object.keys(dumpData).forEach(key => {
                    const element = document.querySelector(`[name="${key}"]`);
                    if (element) {
                        if (element.type === 'radio') {
                            const radio = document.querySelector(`[name="${key}"][value="${dumpData[key]}"]`);
                            if (radio) {
                                radio.checked = true;
                            }
                        } else {
                            element.value = dumpData[key];
                        }
                    }
                });
                // 设置隐藏的 dumpId 字段
                const dumpIdField = document.createElement('input');
                dumpIdField.type = 'hidden';
                dumpIdField.name = 'dumpId';
                dumpIdField.value = dumpId;
                document.getElementById('dumpForm').appendChild(dumpIdField);

                // 加载图片数据
                if (dumpData.images && dumpData.images.length > 0) {
                    dumpData.images.forEach(image => {
                        const row = document.createElement('tr');
                        row.setAttribute('data-url', image.dataUrl);
                        row.innerHTML = `
                            <td><input type="checkbox"></td>
                            <td>${image.name}</td>
                            <td>${image.uploadTime}</td>
                            <td class="image-actions">
                                <button onclick="previewImage('${image.dataUrl}', event)">预览</button>
                                <button onclick="downloadImage('${image.name}', '${image.dataUrl}', event)">下载</button>
                            </td>
                            <td>
                                <span onclick="showImageTypeSelect(this)">${image.type}</span>
                            </td>
                        `;
                        document.getElementById('imageList').appendChild(row);
                    });
                    updateImageFiles();
                }

                // 更新堆渣进度
                updateDumpProgress();

                // 恢复显示状态
                document.getElementById('changeManagement').style.display = dumpData.showChangeManagement ? 'block' : 'none';
                document.getElementById('followUpPlan').style.display = dumpData.showFollowUpPlan ? 'block' : 'none';
                document.getElementById('residentsNearbySection').style.display = dumpData.showResidentsNearby ? 'block' : 'none';

                // 恢复渣场设计方案文件名
                document.getElementById('designPlanFileName').value = dumpData.designPlanFileName || '';
                toggleDesignPlanUpload(dumpData.hasDesignPlan === '是');

                // 触发相关函数以确保正确的显示状态
                if (dumpData.hasLandProcedures === '否') {
                    toggleChangeManagement(true);
                }
                if (dumpData.includedInChangeManagement === '否') {
                    toggleFollowUpPlan(true);
                }
                if (dumpData.dumpType === '沟道型') {
                    toggleResidentsNearbySection();
                }
            }
        }

        // 添加以下 JavaScript 代码来自动调整 textarea 的高度
        document.querySelectorAll('.form-input-underline').forEach(function(textarea) {
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                // 确保最小高度
                if (this.scrollHeight < 30) {
                    this.style.height = '30px';
                }
                // 当有内容时隐藏标签
                if (this.value.trim() !== '') {
                    this.nextElementSibling.style.opacity = '0';
                } else {
                    this.nextElementSibling.style.opacity = '1';
                }
            });
            // 初始化时触发一次以设置正确的高度和标签可见性
            textarea.dispatchEvent(new Event('input'));
        });

        function triggerImageUpload(event) {
            event.preventDefault();
            document.getElementById('imageUpload').click();
        }

        function deleteSelectedImages(event) {
            event.preventDefault();
            const checkboxes = document.querySelectorAll('#imageList input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                if (checkbox.id !== 'selectAll') {
                    const row = checkbox.closest('tr');
                    row.remove();
                }
            });
            updateImageFiles();
        }

        function toggleSelectAll(event) {
            const checkboxes = document.querySelectorAll('#imageList input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.id !== 'selectAll') {
                    checkbox.checked = event.target.checked;
                }
            });
        }

        function updateImageFiles() {
            imageFiles = Array.from(document.querySelectorAll('#imageList tr')).slice(1).map(row => {
                return {
                    name: row.cells[1].textContent,
                    uploadTime: row.cells[2].textContent,
                    dataUrl: row.getAttribute('data-url'),
                    type: row.cells[4].querySelector('span')?.textContent || row.cells[4].querySelector('select')?.value
                };
            });
        }

        document.getElementById('imageUpload').addEventListener('change', function(event) {
            const files = event.target.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const row = document.createElement('tr');
                    row.setAttribute('data-url', e.target.result);
                    row.innerHTML = `
                        <td><input type="checkbox"></td>
                        <td>${file.name}</td>
                        <td>${new Date().toLocaleString()}</td>
                        <td class="image-actions">
                            <button onclick="previewImage('${e.target.result}', event)">预览</button>
                            <button onclick="downloadImage('${file.name}', '${e.target.result}', event)">下载</button>
                        </td>
                        <td>
                            <select onchange="updateImageType(this)">
                                <option value="">请选择</option>
                                <option value="航拍全景">航拍全景</option>
                                <option value="渣场局部">渣场局部</option>
                                <option value="其他">其他</option>
                            </select>
                        </td>
                    `;
                    const table = document.getElementById('imageList');
                    const firstDataRow = table.rows[1]; // 获取标题行之后的第一行
                    if (firstDataRow) {
                        table.insertBefore(row, firstDataRow); // 在第一行数据之前插入新行
                    } else {
                        table.appendChild(row); // 如果没有数据行，则直接添加到表格末尾
                    }
                    updateImageFiles();
                };
                reader.readAsDataURL(file);
            }
        });

        function updateImageType(select) {
            const row = select.closest('tr');
            const imageFile = imageFiles.find(file => file.name === row.cells[1].textContent);
            if (imageFile) {
                imageFile.type = select.value;
                // 更新显示，隐藏下拉菜单，只显示选中的文字
                const selectedText = select.options[select.selectedIndex].text;
                select.style.display = 'none';
                const textSpan = document.createElement('span');
                textSpan.textContent = selectedText;
                textSpan.style.cursor = 'pointer';
                textSpan.onclick = function() {
                    textSpan.style.display = 'none';
                    select.style.display = '';
                };
                select.parentNode.insertBefore(textSpan, select);
            }
        }

        function showImageTypeSelect(span) {
            span.style.display = 'none';
            const td = span.closest('td');
            const select = td.querySelector('select');
            if (select) {
                select.style.display = '';
            } else {
                const newSelect = document.createElement('select');
                newSelect.innerHTML = `
                    <option value="">请选择</option>
                    <option value="航拍全景">航拍全景</option>
                    <option value="渣场局部">渣场局部</option>
                    <option value="其他">其他</option>
                `;
                newSelect.value = span.textContent;
                newSelect.onchange = function() {
                    updateImageType(this);
                };
                td.appendChild(newSelect);
            }
        }

        function previewImage(src, event) {
            event.preventDefault();
            event.stopPropagation();
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '1000';

            const imgContainer = document.createElement('div');
            imgContainer.style.position = 'relative';
            imgContainer.style.maxWidth = '80%';
            imgContainer.style.maxHeight = '80%';

            const img = document.createElement('img');
            img.src = src;
            img.style.width = '100%';
            img.style.height = 'auto';
            img.style.maxWidth = '80%';
            img.style.display = 'block';
            img.style.borderRadius = '5px';

            const closeButton = document.createElement('button');
            closeButton.textContent = '关闭';
            closeButton.style.position = 'absolute';
            closeButton.style.top = '10px';
            closeButton.style.right = '10px';
            closeButton.style.padding = '5px 10px';
            closeButton.style.fontSize = '16px';
            closeButton.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
            closeButton.style.border = 'none';
            closeButton.style.borderRadius = '5px';
            closeButton.style.cursor = 'pointer';

            closeButton.addEventListener('click', function(e) {
                e.stopPropagation();
                document.body.removeChild(modal);
            });

            imgContainer.appendChild(img);
            imgContainer.appendChild(closeButton);
            modal.appendChild(imgContainer);
            document.body.appendChild(modal);

            modal.addEventListener('click', function() {
                document.body.removeChild(modal);
            });

            imgContainer.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }

        function downloadImage(fileName, dataUrl, event) {
            event.preventDefault();
            event.stopPropagation();
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function updateDumpProgress() {
            const actualCapacity = parseFloat(document.querySelector('input[name="actualCapacity"]').value) || 0;
            const approvedCapacity = parseFloat(document.querySelector('input[name="approvedCapacity"]').value) || 1;
            
            const progress = actualCapacity / approvedCapacity;
            const progressPercentage = Math.min(progress * 100, 100).toFixed(2);
            
            const progressBar = document.getElementById('dumpProgress');
            const progressText = document.getElementById('dumpProgressText');
            
            progressBar.style.width = `${progressPercentage}%`;
            progressBar.style.backgroundColor = progress > 1 ? 'red' : 'green';
            progressText.textContent = `${progressPercentage}%`;
        }
    </script>
</body>
</html>
    <script>
        let imageFiles = [];

        document.addEventListener('DOMContentLoaded', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const dumpId = urlParams.get('id');
            if (dumpId) {
                loadDumpData(dumpId);
                disableForm();
                document.querySelector('.btn-edit').style.display = 'inline-block';
                document.querySelector('.btn-save').style.display = 'none';
            } else {
                document.querySelector('.btn-edit').style.display = 'none';
                document.querySelector('.btn-save').style.display = 'inline-block';
            }

            // 为渣场名称输入框添加事件监听器
            const dumpNameInput = document.querySelector('input[name="dumpName"]');
            dumpNameInput.addEventListener('change', checkDumpNameExists);

            // 为其他输入框添加事件监听器
            const form = document.getElementById('dumpForm');
            form.addEventListener('input', function(event) {
                if (event.target.name !== 'dumpName' && dumpNameInput.value.trim() !== '') {
                    checkDumpNameExists.call(dumpNameInput);
                }
            });

            // 为实际堆渣量和设计堆渣量输入框添加事件监听器
            const actualCapacityInput = document.querySelector('input[name="actualCapacity"]');
            const designedCapacityInput = document.querySelector('input[name="designedCapacity"]');

            actualCapacityInput.addEventListener('input', updateDumpProgress);
            designedCapacityInput.addEventListener('input', updateDumpProgress);

            // 如果是编辑模式，立即更新进度条
            if (dumpId) {
                updateDumpProgress();
            }
        });

        function checkDumpNameExists() {
            const dumpName = this.value.trim();
            if (dumpName) {
                const dumps = JSON.parse(localStorage.getItem('dumps')) || [];
                const existingDump = dumps.find(d => d.dumpName === dumpName && d.dumpId !== document.querySelector('input[name="dumpId"]')?.value);
                if (existingDump) {
                    alert('渣场名称已存在，请重新输入');
                    this.value = ''; // 清空输入
                    this.focus(); // 重新聚焦到输入框
                }
            }
        }

        function saveDumpData() {
            // 收集表单数据
            const formData = new FormData(document.getElementById('dumpForm'));
            const dumpData = Object.fromEntries(formData.entries());

            // 检查必填项
            if (!dumpData.dumpName || !dumpData.dumpLocation || !dumpData.dumpStatus) {
                alert('渣场名称、渣场位置和渣场状态为必填项，请填写完整。');
                return;
            }

            // 获取现有的渣场数据
            let dumps = JSON.parse(localStorage.getItem('dumps')) || [];

            const urlParams = new URLSearchParams(window.location.search);
            const editId = urlParams.get('id');

            // 添加图片数据
            dumpData.images = imageFiles.map(file => ({
                name: file.name,
                uploadTime: file.uploadTime,
                dataUrl: file.dataUrl,
                type: file.type
            }));

            // 确保所有字段都被包含在dumpData中
            dumpData.coordinates = dumpData.coordinates || '';
            dumpData.dumpLevel = dumpData.dumpLevel || '';
            dumpData.approvedHeight = dumpData.approvedHeight || '';
            dumpData.actualHeight = dumpData.actualHeight || '';
            dumpData.approvedCapacity = dumpData.approvedCapacity || '';
            dumpData.actualCapacity = dumpData.actualCapacity || '';

            if (editId) {
                // 更新现有渣场
                const editIndex = dumps.findIndex(dump => dump.dumpId === editId);
                if (editIndex !== -1) {
                    // 保留原有的 dumpId
                    dumpData.dumpId = editId;
                    dumps[editIndex] = dumpData;
                } else {
                    alert('未找到要编辑的渣场数据');
                    return;
                }
            } else {
                // 新建渣场
                dumpData.dumpId = Date.now().toString();
                dumps.push(dumpData);
            }

            // 保存更新后的数据
            localStorage.setItem('dumps', JSON.stringify(dumps));

            // 禁用表单字段
            disableForm();

            // 显示保存成功消息
            alert('保存成功');

            // 跳转回列表页面
            window.location.href = 'dump-list.html';
        }

        function disableForm() {
            const form = document.getElementById('dumpForm');
            const inputs = form.querySelectorAll('input:not([type="hidden"]), select, textarea');
            inputs.forEach(input => {
                input.disabled = true;
            });
            document.querySelector('.btn-edit').style.display = 'inline-block';
            document.querySelector('.btn-save').style.display = 'none';
        }

        function editForm() {
            const form = document.getElementById('dumpForm');
            const inputs = form.querySelectorAll('input:not([type="hidden"]), select, textarea');
            inputs.forEach(input => {
                input.disabled = false;
            });
            document.querySelector('.btn-edit').style.display = 'none';
            document.querySelector('.btn-save').style.display = 'inline-block';
        }

        function loadDumpData(dumpId) {
            const dumps = JSON.parse(localStorage.getItem('dumps')) || [];
            const dumpData = dumps.find(dump => dump.dumpId === dumpId);

            if (dumpData) {
                Object.keys(dumpData).forEach(key => {
                    const element = document.querySelector(`[name="${key}"]`);
                    if (element) {
                        if (element.type === 'radio') {
                            const radio = document.querySelector(`[name="${key}"][value="${dumpData[key]}"]`);
                            if (radio) {
                                radio.checked = true;
                            }
                        } else {
                            element.value = dumpData[key];
                        }
                    }
                });
                // 设置隐藏的 dumpId 字段
                const dumpIdField = document.createElement('input');
                dumpIdField.type = 'hidden';
                dumpIdField.name = 'dumpId';
                dumpIdField.value = dumpId;
                document.getElementById('dumpForm').appendChild(dumpIdField);

                // 加载图片数据
                if (dumpData.images && dumpData.images.length > 0) {
                    dumpData.images.forEach(image => {
                        const row = document.createElement('tr');
                        row.setAttribute('data-url', image.dataUrl);
                        row.innerHTML = `
                            <td><input type="checkbox"></td>
                            <td>${image.name}</td>
                            <td>${image.uploadTime}</td>
                            <td class="image-actions">
                                <button onclick="previewImage('${image.dataUrl}', event)">预览</button>
                                <button onclick="downloadImage('${image.name}', '${image.dataUrl}', event)">下载</button>
                            </td>
                            <td>
                                <span onclick="showImageTypeSelect(this)">${image.type}</span>
                            </td>
                        `;
                        document.getElementById('imageList').appendChild(row);
                    });
                    updateImageFiles();
                }

                // 更新堆渣进度
                updateDumpProgress();
            }
        }

        // 添加以下 JavaScript 代码来自动调整 textarea 的高度
        document.querySelectorAll('.form-input-underline').forEach(function(textarea) {
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                // 确保最小高度
                if (this.scrollHeight < 30) {
                    this.style.height = '30px';
                }
                // 当有内容时隐藏标签
                if (this.value.trim() !== '') {
                    this.nextElementSibling.style.opacity = '0';
                } else {
                    this.nextElementSibling.style.opacity = '1';
                }
            });
            // 初始化时触发一次以设置正确的高度和标签可见性
            textarea.dispatchEvent(new Event('input'));
        });

        function triggerImageUpload(event) {
            event.preventDefault();
            document.getElementById('imageUpload').click();
        }

        function deleteSelectedImages(event) {
            event.preventDefault();
            const checkboxes = document.querySelectorAll('#imageList input[type="checkbox"]:checked');
            checkboxes.forEach(checkbox => {
                if (checkbox.id !== 'selectAll') {
                    const row = checkbox.closest('tr');
                    row.remove();
                }
            });
            updateImageFiles();
        }

        function toggleSelectAll(event) {
            const checkboxes = document.querySelectorAll('#imageList input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                if (checkbox.id !== 'selectAll') {
                    checkbox.checked = event.target.checked;
                }
            });
        }

        function updateImageFiles() {
            imageFiles = Array.from(document.querySelectorAll('#imageList tr')).slice(1).map(row => {
                return {
                    name: row.cells[1].textContent,
                    uploadTime: row.cells[2].textContent,
                    dataUrl: row.getAttribute('data-url'),
                    type: row.cells[4].querySelector('span')?.textContent || row.cells[4].querySelector('select')?.value
                };
            });
        }

        document.getElementById('imageUpload').addEventListener('change', function(event) {
            const files = event.target.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const reader = new FileReader();
                reader.onload = function(e) {
                    const row = document.createElement('tr');
                    row.setAttribute('data-url', e.target.result);
                    row.innerHTML = `
                        <td><input type="checkbox"></td>
                        <td>${file.name}</td>
                        <td>${new Date().toLocaleString()}</td>
                        <td class="image-actions">
                            <button onclick="previewImage('${e.target.result}', event)">预览</button>
                            <button onclick="downloadImage('${file.name}', '${e.target.result}', event)">下载</button>
                        </td>
                        <td>
                            <select onchange="updateImageType(this)">
                                <option value="">请选择</option>
                                <option value="航拍全景">航拍全景</option>
                                <option value="渣场局部">渣场局部</option>
                                <option value="其他">其他</option>
                            </select>
                        </td>
                    `;
                    const table = document.getElementById('imageList');
                    const firstDataRow = table.rows[1]; // 获取标题行之后的第一行
                    if (firstDataRow) {
                        table.insertBefore(row, firstDataRow); // 在第一行数据之前插入新行
                    } else {
                        table.appendChild(row); // 如果没有数据行，则直接添加到表格末尾
                    }
                    updateImageFiles();
                };
                reader.readAsDataURL(file);
            }
        });

        function updateImageType(select) {
            const row = select.closest('tr');
            const imageFile = imageFiles.find(file => file.name === row.cells[1].textContent);
            if (imageFile) {
                imageFile.type = select.value;
                // 更新显示，隐藏下拉菜单，只显示选中的文字
                const selectedText = select.options[select.selectedIndex].text;
                select.style.display = 'none';
                const textSpan = document.createElement('span');
                textSpan.textContent = selectedText;
                textSpan.style.cursor = 'pointer';
                textSpan.onclick = function() {
                    textSpan.style.display = 'none';
                    select.style.display = '';
                };
                select.parentNode.insertBefore(textSpan, select);
            }
        }

        function showImageTypeSelect(span) {
            span.style.display = 'none';
            const td = span.closest('td');
            const select = td.querySelector('select');
            if (select) {
                select.style.display = '';
            } else {
                const newSelect = document.createElement('select');
                newSelect.innerHTML = `
                    <option value="">请选择</option>
                    <option value="航拍全景">航拍全景</option>
                    <option value="渣场局部">渣场局部</option>
                    <option value="其他">其他</option>
                `;
                newSelect.value = span.textContent;
                newSelect.onchange = function() {
                    updateImageType(this);
                };
                td.appendChild(newSelect);
            }
        }

        function previewImage(src, event) {
            event.preventDefault();
            event.stopPropagation();
            const modal = document.createElement('div');
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0,0,0,0.8)';
            modal.style.display = 'flex';
            modal.style.justifyContent = 'center';
            modal.style.alignItems = 'center';
            modal.style.zIndex = '1000';

            const imgContainer = document.createElement('div');
            imgContainer.style.position = 'relative';
            imgContainer.style.maxWidth = '80%';
            imgContainer.style.maxHeight = '80%';

            const img = document.createElement('img');
            img.src = src;
            img.style.width = '100%';
            img.style.height = 'auto';
            img.style.maxWidth = '80%';
            img.style.display = 'block';
            img.style.borderRadius = '5px';

            const closeButton = document.createElement('button');
            closeButton.textContent = '关闭';
            closeButton.style.position = 'absolute';
            closeButton.style.top = '10px';
            closeButton.style.right = '10px';
            closeButton.style.padding = '5px 10px';
            closeButton.style.fontSize = '16px';
            closeButton.style.backgroundColor = 'rgba(255, 255, 255, 0.7)';
            closeButton.style.border = 'none';
            closeButton.style.borderRadius = '5px';
            closeButton.style.cursor = 'pointer';

            closeButton.addEventListener('click', function(e) {
                e.stopPropagation();
                document.body.removeChild(modal);
            });

            imgContainer.appendChild(img);
            imgContainer.appendChild(closeButton);
            modal.appendChild(imgContainer);
            document.body.appendChild(modal);

            modal.addEventListener('click', function() {
                document.body.removeChild(modal);
            });

            imgContainer.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }

        function downloadImage(fileName, dataUrl, event) {
            event.preventDefault();
            event.stopPropagation();
            const link = document.createElement('a');
            link.href = dataUrl;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function updateDumpProgress() {
            const actualCapacity = parseFloat(document.querySelector('input[name="actualCapacity"]').value) || 0;
            const designedCapacity = parseFloat(document.querySelector('input[name="designedCapacity"]').value) || 1;
            
            const progress = actualCapacity / designedCapacity;
            const progressPercentage = Math.min(progress * 100, 100).toFixed(2);
            
            const progressBar = document.getElementById('dumpProgress');
            const progressText = document.getElementById('dumpProgressText');
            
            progressBar.style.width = `${progressPercentage}%`;
            progressBar.style.backgroundColor = progress > 1 ? 'red' : 'green';
            progressText.textContent = `${progressPercentage}%`;
        }
    </script>
</body>
</html>